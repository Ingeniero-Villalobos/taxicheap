rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regla para la colección 'pasajeros'
    match /pasajeros/{pasajeroId} {
      // Permitir lectura y escritura solo si el usuario está autenticado y su UID coincide con el ID del pasajero
      allow read, write: if request.auth != null && request.auth.uid == pasajeroId;
      allow get: if request.auth.token.role == 'conductor';
      
    }

    match /conductores/{conductorId} {
      allow read, write: if request.auth != null && request.auth.uid == conductorId;
      allow list: if request.auth != null && resource.data.activo == true;
      allow get: if request.auth.token.role == 'pasajero';

    }
    
    match /cupones/{cuponesId} {
      allow read, write: if
        request.auth != null &&
        (
          request.resource.data.pasajeroId.id == request.auth.uid ||
          request.resource.data.conductoresId.id == request.auth.uid
        );
    }
    
    match /viajes/{viajeId} {
      
      // Permitir la creación de documentos solo para usuarios autenticados
      allow create: if request.auth != null;

      // Permitir que cualquier conductor o pasajero autenticado vea viajes pendientes
      allow read: if request.auth != null && resource.data.estado == 'pendiente';

      // Permitir que solo el pasajero o el conductor actualicen su viaje
      allow update: if request.auth != null &&
                    (
                      resource.data.pasajeroId.id == request.auth.uid ||  // Solo el pasajero puede actualizar su viaje
                      resource.data.conductorId.id == request.auth.uid    // O el conductor puede actualizar su viaje
                    );

      // Permitir eliminar solo al pasajero o conductor
      allow delete: if request.auth != null &&
                    (
                      resource.data.pasajeroId.id == request.auth.uid ||  // Solo el pasajero puede eliminar su viaje
                      resource.data.conductorId.id == request.auth.uid    // O el conductor puede eliminar su viaje
                    );
    }

    match /notificaciones_conductores/{notificacionId} {
      // Permitir la creación si el usuario está autenticado y el viaje existe
      allow create: if request.auth != null &&
        exists(/databases/$(database)/documents/viajes/$(resource.data.viajeId)) &&
        (
          get(/databases/$(database)/documents/viajes/$(resource.data.viajeId)).data.pasajeroId.id == request.auth.uid || 
          get(/databases/$(database)/documents/viajes/$(resource.data.viajeId)).data.conductorId.id == request.auth.uid
        );

      // Permitir leer y actualizar si el viaje corresponde al usuario
      allow read, update: if request.auth != null &&
        (
          get(/databases/$(database)/documents/viajes/$(resource.data.viajeId)).data.pasajeroId.id == request.auth.uid || 
          get(/databases/$(database)/documents/viajes/$(resource.data.viajeId)).data.conductorId.id == request.auth.uid
        );
    }

  }
}